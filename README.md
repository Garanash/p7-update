# Скрипт обновления остатков

Скрипт для автоматического обновления остатков в файле "Сборка Москва.xlsx" из файла, полученного по почте.

## Функционал

1. Подключается к почте Mail.ru и ищет последнее письмо с Excel вложением (файл "для бота")
2. Скачивает файл из почты
3. Обновляет лист "остатки" в файле "Сборка Москва.xlsx" (удаляет дубликаты типа "остатки1", "остатки2")
4. Нормализует столбец "Артикул" (убирает пробелы)
5. На всех листах, где есть столбец "Кол-во на станок", создает после него столбец "Остатки на складах"
6. Обновляет остатки на всех листах с использованием частичного совпадения номеров каталога

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Настройка

### Настройка почты

Скрипт настроен на работу с почтой **almazgeobur.it@mail.ru**.

Настройки почты находятся в файле `update_ostanki.py`:
- EMAIL_LOGIN = "almazgeobur.it@mail.ru"
- EMAIL_PASSWORD = "Ba9uV5zDx6rE1fs6PgsV"
- IMAP_SERVER = "imap.mail.ru"

### Настройка P7-Офис Document Server

Скрипт поддерживает работу с корпоративной лицензией **P7-Офис Corporate Server 2024** и **P7 Document Server**. Перед обновлением файла скрипт автоматически закрывает все активные сеансы пользователей через Document Server API.

**Краткая инструкция:**
1. Создайте файл `config_p7.py` в папке проекта
2. Скопируйте туда данные из вашего P7 Document Server
3. Заполните три параметра: `P7_DOC_SERVER_URL`, `P7_ACCESS_TOKEN`, `P7_FILE_ID`
4. Сохраните файл

**Где брать данные:** см. раздел "Шаг 2: Где брать данные для настройки" ниже.

#### Шаг 1: Создание файла конфигурации

Создайте файл `config_p7.py` в корне проекта на основе примера:

**Windows:**
```bash
copy config_p7.py.example config_p7.py
```

**Linux/Mac:**
```bash
cp config_p7.py.example config_p7.py
```

Или создайте файл вручную в папке проекта.

#### Шаг 2: Получение данных для настройки

**1. P7_DOC_SERVER_URL (URL Document Server)**

Это адрес вашего P7 Document Server. Обычно это:
- `http://your-server-ip:8080` - если Document Server на отдельном сервере
- `http://localhost:8080` - если Document Server на том же компьютере
- `https://doc-server.company.com` - если используется доменное имя

**Где найти:**
- В настройках P7 Corporate Server 2024 (административная панель)
- В документации по настройке Document Server
- У администратора P7-Офис в вашей организации

**Документация:**
- Document Server - настройки: https://support.r7-office.ru/category/document_server/settings-ds/
- Document Server - общая документация: https://support.r7-office.ru/category/document_server/
- Corporate Server 2024: https://support.r7-office.ru/category/corporate-server2024/

**Пример:**
```python
P7_DOC_SERVER_URL = "http://192.168.1.100:8080"
# или
P7_DOC_SERVER_URL = "https://doc-server.company.local"
```

**2. P7_ACCESS_TOKEN (Токен доступа)**

Токен для аутентификации в API (если требуется).

**Где найти:**
- В настройках безопасности P7 Document Server (административная панель)
- В разделе "API и интеграция" Corporate Server
- Может быть необязательным, если используется внутренняя сеть без аутентификации

**Документация:**
- API Document Server: https://support.r7-office.ru/category/document_server/api-document_server/
- Использование API: https://support.r7-office.ru/document_server/api-document_server/using-api-document_server/
- Настройки Document Server: https://support.r7-office.ru/category/document_server/settings-ds/

**Пример:**
```python
P7_ACCESS_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIn0..."
# или оставьте пустым, если токен не требуется:
P7_ACCESS_TOKEN = ""
```

**3. P7_FILE_ID (ID или имя файла)**

Идентификатор файла в Document Server или просто имя файла.

**Где найти:**
- Если файл загружен в Document Server - используйте ID файла из системы
- Или просто укажите имя файла: `Сборка Москва.xlsx`
- ID можно найти в URL при открытии файла в P7-Офис (в адресной строке браузера)
- В административной панели Document Server в списке файлов

**Документация:**
- API Document Server: https://support.r7-office.ru/category/document_server/api-document_server/
- Использование API: https://support.r7-office.ru/document_server/api-document_server/using-api-document_server/
- Конфигурация API: https://support.r7-office.ru/document_server/api-document_server/using-api-document_server/config/config/

**Примеры:**

**Пример:**
```python
P7_FILE_ID = "Сборка Москва.xlsx"
# или ID файла в системе:
P7_FILE_ID = "file-id-12345-67890"
```

#### Шаг 3: Заполнение config_p7.py

Откройте файл `config_p7.py` в текстовом редакторе и заполните значения:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# URL вашего P7 Document Server
# Пример: "http://192.168.1.100:8080" или "https://doc-server.company.com"
P7_DOC_SERVER_URL = "http://ваш-сервер:8080"

# Токен доступа (если требуется)
# Оставьте пустым "", если токен не нужен
P7_ACCESS_TOKEN = "ваш-токен-или-пусто"

# ID файла или имя файла
# Пример: "Сборка Москва.xlsx" или "file-id-12345"
P7_FILE_ID = "Сборка Москва.xlsx"
```

#### Примеры конфигурации

**Пример 1: Document Server на локальной сети**
```python
P7_DOC_SERVER_URL = "http://192.168.1.50:8080"
P7_ACCESS_TOKEN = ""
P7_FILE_ID = "Сборка Москва.xlsx"
```

**Пример 2: Document Server с доменным именем и токеном**
```python
P7_DOC_SERVER_URL = "https://doc-server.company.local"
P7_ACCESS_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
P7_FILE_ID = "file-abc123-def456"
```

**Пример 3: Без Document Server (локальное закрытие)**
```python
# Оставьте значения по умолчанию или не создавайте config_p7.py
# Скрипт автоматически использует локальное закрытие процессов
P7_DOC_SERVER_URL = ""
P7_ACCESS_TOKEN = ""
P7_FILE_ID = ""
```

#### Проверка настройки

После настройки запустите скрипт и проверьте логи:
- Если видите `Закрытие сеансов P7-Офис через Document Server API` - API настроен правильно
- Если видите `P7_DOC_SERVER_URL не настроен, используем локальное закрытие процессов` - используется локальный метод

#### Как работает закрытие сеансов

1. **Через P7 Document Server API** (если настроен):
   - Использует WOPI REST API для получения информации о файле
   - Проверяет активные сеансы через `/api/v1/sessions`
   - Закрывает все сеансы, связанные с файлом, через DELETE запрос
   - Снимает блокировки файла через WOPI Unlock
   - Ожидает освобождения файла до 30 секунд

2. **Локальное закрытие процессов** (если API не настроен):
   - Ищет процессы P7-Офис, открывающие файл
   - Закрывает процессы через psutil
   - Ожидает освобождения файла

#### Шаг 4: Примеры заполнения config_p7.py

**Пример 1: Document Server в локальной сети (без токена)**
```python
P7_DOC_SERVER_URL = "http://192.168.1.50:8080"
P7_ACCESS_TOKEN = ""
P7_FILE_ID = "Сборка Москва.xlsx"
```

**Пример 2: Document Server с доменным именем и токеном**
```python
P7_DOC_SERVER_URL = "https://doc-server.company.local"
P7_ACCESS_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIn0..."
P7_FILE_ID = "file-abc123-def456"
```

**Пример 3: Без Document Server (использование локального закрытия)**
```python
# Если не знаете параметры или не используете Document Server:
P7_DOC_SERVER_URL = ""
P7_ACCESS_TOKEN = ""
P7_FILE_ID = ""
# Или просто не создавайте config_p7.py - скрипт автоматически использует локальное закрытие
```

#### Шаг 5: Проверка настройки

После заполнения `config_p7.py` запустите скрипт и проверьте вывод:

**Если API настроен правильно, вы увидите:**
```
Закрытие сеансов P7-Офис через Document Server API для файла: Сборка Москва.xlsx
Проверка информации о файле через WOPI API...
Файл найден в Document Server
```

**Если API не настроен, вы увидите:**
```
P7_DOC_SERVER_URL не настроен, используем локальное закрытие процессов
Локальное закрытие процессов для файла: ...
```

#### Полезные ссылки на документацию P7-Офис

**Основная документация:**

1. **Document Server - Установка и настройка:**
   - https://support.r7-office.ru/category/document_server/ustanovka-i-nastrojka/
   - Здесь можно найти URL сервера и параметры подключения

2. **Document Server - API:**
   - https://support.r7-office.ru/category/document_server/api-document_server/
   - Описание всех API endpoints, включая получение токенов

3. **WOPI REST API:**
   - https://support.r7-office.ru/category/document_server/api-document_server/wopi-rest-api/
   - Документация по WOPI протоколу для работы с файлами

4. **Corporate Server 2024:**
   - https://support.r7-office.ru/category/corporate-server2024/
   - Настройка корпоративного сервера и интеграция с Document Server

5. **Настройка безопасности:**
   - https://support.r7-office.ru/category/document_server/ustanovka-i-nastrojka/nastrojka-bezopasnosti/
   - Настройка токенов доступа и аутентификации

**Где конкретно искать параметры:**

- **P7_DOC_SERVER_URL**: Раздел "Установка и настройка" → "Настройка сетевых параметров"
- **P7_ACCESS_TOKEN**: Раздел "API" → "Аутентификация" или "Настройка безопасности" → "Токены доступа"
- **P7_FILE_ID**: Раздел "API" → "Работа с файлами" или в URL при открытии файла в браузере

3. **Обратитесь к администратору P7-Офис** в вашей организации для получения:
   - URL Document Server
   - Токена доступа (если требуется)
   - ID файла в системе

#### Важные замечания

- Скрипт автоматически определяет, использовать ли API или локальный метод
- Если `P7_DOC_SERVER_URL` не настроен или содержит значения по умолчанию, используется локальное закрытие
- Закрытие сеансов происходит **дважды**: перед обновлением листа "остатки" и перед обновлением остатков на всех листах
- Все пользователи будут автоматически отключены от файла перед обновлением
- Файл должен быть доступен для записи после закрытия сеансов

## Использование

### Ручной запуск с почтой (основной режим):
```bash
python update_ostanki.py
```

### Тестирование с локальным файлом:
```bash
python update_ostanki.py "для бота (XLSX).xlsx"
```

### Автоматический запуск каждый день в 19:20

#### Вариант 1: Использование планировщика Python (рекомендуется)
```bash
python scheduler.py
```
Скрипт будет работать постоянно и запускать обновление каждый день в 19:20.

Для запуска в фоне можно использовать:
```bash
start /B python scheduler.py
```

Или используйте bat-файл:
```bash
start_scheduler.bat
```

#### Вариант 2: Планировщик задач Windows
Запустите `install_windows_task.bat` от имени администратора для автоматической установки задачи в планировщике Windows.

Или создайте задачу вручную:
1. Откройте "Планировщик заданий Windows"
2. Создайте новую задачу
3. Триггер: ежедневно в 19:20
4. Действие: запуск программы `python` с аргументом `scheduler.py`
5. Рабочая папка: путь к проекту

## Структура файлов

- `update_ostanki.py` - основной скрипт обновления остатков
- `scheduler.py` - планировщик для автоматического запуска
- `start_scheduler.bat` - bat-файл для запуска планировщика
- `install_windows_task.bat` - установка задачи в планировщике Windows
- `config_p7.py.example` - пример конфигурации для P7 Document Server
- `config_p7.py` - реальная конфигурация (создается вручную, не коммитится в git)
- `Сборка Москва.xlsx` - основной файл с данными
- `для бота (XLSX).xlsx` - файл с остатками (скачивается из почты или используется локально)

## Формат данных

Скрипт ищет в файле бота:
- Столбец "Номер" (числовой код каталога)
- Столбец "Номенклатура" или "Номенклатура.код"
- Столбец "Количество" (остатки)
- Столбец "Артикул" (нормализуется - убираются пробелы)

В основном файле скрипт ищет:
- Столбцы "Номер по каталогу" и "Номер по каталогу АГБ"
- Столбец "Кол-во на станок" (после него создается "Остатки на складах")

## Особенности

- **Нормализация данных**: Все номера каталога и артикулы нормализуются (убираются пробелы, приводятся к нижнему регистру)
- **Частичное совпадение**: Используется частичное совпадение при поиске (содержание строки в строке), если точного совпадения нет
- **Удаление дубликатов**: Автоматически удаляются дубликаты листа "остатки" (остатки1, остатки2 и т.д.)
- **Обработка объединенных ячеек**: Пропускаются объединенные ячейки при обновлении

## Примечания

- Скрипт суммирует остатки для одинаковых номеров каталога
- Если для номера каталога нет остатков, ставится 0
- Скрипт обновляет все листы, кроме листа "остатки"
- **Автоматическое закрытие сеансов**: Все пользователи P7-Офис автоматически отключаются от файла перед обновлением
- Если используется P7 Document Server, файл должен быть загружен в систему и доступен через API
- При работе без Document Server скрипт закрывает локальные процессы P7-Офис

## Работа с P7-Офис Document Server

### Требования

- P7-Офис Corporate Server 2024 или Document Server
- Доступ к WOPI REST API
- Файл должен быть загружен в Document Server
- Токен доступа (если требуется аутентификация)

### API Endpoints, используемые скриптом

1. **WOPI CheckFileInfo** - `GET /wopi/files/{file_id}/checkfileinfo`
   - Получение информации о файле и блокировках

2. **WOPI Unlock** - `POST /wopi/files/{file_id}/unlock`
   - Снятие блокировки файла

3. **Sessions API** - `GET /api/v1/sessions`
   - Получение списка активных сеансов

4. **Close Session** - `DELETE /api/v1/sessions/{session_id}`
   - Закрытие конкретного сеанса

### Логи работы с P7 Document Server

При работе скрипта вы увидите следующие сообщения:
- `Закрытие сеансов P7-Офис через Document Server API для файла: ...`
- `Проверка информации о файле через WOPI API...`
- `Файл найден в Document Server`
- `Найдено X активных сеансов`
- `Сеанс {session_id} закрыт`
- `Файл освобожден и готов к обновлению`

Если API не настроен:
- `P7_DOC_SERVER_URL не настроен, используем локальное закрытие процессов`
- `Локальное закрытие процессов для файла: ...`
