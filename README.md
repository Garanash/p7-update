# Скрипт обновления остатков

Скрипт для автоматического обновления остатков в файле "Сборка Москва.xlsx" из файла, полученного по почте.

## Функционал

1. Подключается к почте Mail.ru и ищет последнее письмо с Excel вложением (файл "для бота")
2. Скачивает файл из почты
3. Обновляет лист "остатки" в файле "Сборка Москва.xlsx" (удаляет дубликаты типа "остатки1", "остатки2")
4. Нормализует столбец "Артикул" (убирает пробелы)
5. На всех листах, где есть столбец "Кол-во на станок", создает после него столбец "Остатки на складах"
6. Обновляет остатки на всех листах с использованием частичного совпадения номеров каталога

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Настройка

### Настройка почты

Скрипт настроен на работу с почтой **almazgeobur.it@mail.ru**.

Настройки почты находятся в файле `update_ostanki.py`:
- EMAIL_LOGIN = "almazgeobur.it@mail.ru"
- EMAIL_PASSWORD = "Ba9uV5zDx6rE1fs6PgsV"
- IMAP_SERVER = "imap.mail.ru"

### Настройка P7-Офис Document Server

Для работы с корпоративной лицензией P7-Офис необходимо настроить подключение к Document Server:

1. Создайте файл `config_p7.py` на основе `config_p7.py.example`:
```python
P7_DOC_SERVER_URL = "http://your-p7-doc-server:8080"
P7_ACCESS_TOKEN = "your-access-token-here"
P7_FILE_ID = "your-file-id-or-filename"
```

2. Укажите параметры:
   - `P7_DOC_SERVER_URL` - URL вашего P7 Document Server
   - `P7_ACCESS_TOKEN` - токен доступа для API (если требуется)
   - `P7_FILE_ID` - ID файла в Document Server (или имя файла)

3. Если `config_p7.py` не настроен, скрипт будет использовать локальное закрытие процессов через psutil.

**Важно:** Скрипт автоматически закрывает все сеансы P7-Офис, работающие с файлом, перед обновлением данных через Document Server API.

## Использование

### Ручной запуск с почтой (основной режим):
```bash
python update_ostanki.py
```

### Тестирование с локальным файлом:
```bash
python update_ostanki.py "для бота (XLSX).xlsx"
```

### Автоматический запуск каждый день в 19:20

#### Вариант 1: Использование планировщика Python (рекомендуется)
```bash
python scheduler.py
```
Скрипт будет работать постоянно и запускать обновление каждый день в 19:20.

Для запуска в фоне можно использовать:
```bash
start /B python scheduler.py
```

Или используйте bat-файл:
```bash
start_scheduler.bat
```

#### Вариант 2: Планировщик задач Windows
Запустите `install_windows_task.bat` от имени администратора для автоматической установки задачи в планировщике Windows.

Или создайте задачу вручную:
1. Откройте "Планировщик заданий Windows"
2. Создайте новую задачу
3. Триггер: ежедневно в 19:20
4. Действие: запуск программы `python` с аргументом `scheduler.py`
5. Рабочая папка: путь к проекту

## Структура файлов

- `update_ostanki.py` - основной скрипт обновления остатков
- `scheduler.py` - планировщик для автоматического запуска
- `start_scheduler.bat` - bat-файл для запуска планировщика
- `install_windows_task.bat` - установка задачи в планировщике Windows
- `Сборка Москва.xlsx` - основной файл с данными
- `для бота (XLSX).xlsx` - файл с остатками (скачивается из почты или используется локально)

## Формат данных

Скрипт ищет в файле бота:
- Столбец "Номер" (числовой код каталога)
- Столбец "Номенклатура" или "Номенклатура.код"
- Столбец "Количество" (остатки)
- Столбец "Артикул" (нормализуется - убираются пробелы)

В основном файле скрипт ищет:
- Столбцы "Номер по каталогу" и "Номер по каталогу АГБ"
- Столбец "Кол-во на станок" (после него создается "Остатки на складах")

## Особенности

- **Нормализация данных**: Все номера каталога и артикулы нормализуются (убираются пробелы, приводятся к нижнему регистру)
- **Частичное совпадение**: Используется частичное совпадение при поиске (содержание строки в строке), если точного совпадения нет
- **Удаление дубликатов**: Автоматически удаляются дубликаты листа "остатки" (остатки1, остатки2 и т.д.)
- **Обработка объединенных ячеек**: Пропускаются объединенные ячейки при обновлении

## Примечания

- Скрипт суммирует остатки для одинаковых номеров каталога
- Если для номера каталога нет остатков, ставится 0
- Скрипт обновляет все листы, кроме листа "остатки"
- Файл "Сборка Москва.xlsx" должен быть закрыт в Excel при запуске скрипта
