# Скрипт обновления остатков

Скрипт для автоматического обновления остатков в файле "Сборка Москва.xlsx" из файла, полученного по почте.

## Функционал

1. Подключается к почте Mail.ru и ищет последнее письмо с Excel вложением (файл "для бота")
2. Скачивает файл из почты
3. Обновляет лист "остатки" в файле "Сборка Москва.xlsx" (удаляет дубликаты типа "остатки1", "остатки2")
4. Нормализует столбец "Артикул" (убирает пробелы)
5. На всех листах, где есть столбец "Кол-во на станок", создает после него столбец "Остатки на складах"
6. Обновляет остатки на всех листах с использованием частичного совпадения номеров каталога

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Настройка

### Настройка почты

Скрипт настроен на работу с почтой **almazgeobur.it@mail.ru**.

Настройки почты находятся в файле `update_ostanki.py`:
- EMAIL_LOGIN = "almazgeobur.it@mail.ru"
- EMAIL_PASSWORD = "Ba9uV5zDx6rE1fs6PgsV"
- IMAP_SERVER = "imap.mail.ru"

### Настройка P7-Офис Document Server

Скрипт поддерживает работу с корпоративной лицензией **P7-Офис Corporate Server 2024** и **P7 Document Server**. Перед обновлением файла скрипт автоматически закрывает все активные сеансы пользователей через Document Server API.

#### Настройка подключения

1. **Создайте файл конфигурации** `config_p7.py` на основе `config_p7.py.example`:
```bash
cp config_p7.py.example config_p7.py
```

2. **Отредактируйте `config_p7.py`** и укажите параметры вашего P7 Document Server:
```python
P7_DOC_SERVER_URL = "http://your-p7-doc-server:8080"
P7_ACCESS_TOKEN = "your-access-token-here"
P7_FILE_ID = "your-file-id-or-filename"
```

#### Параметры конфигурации

- **`P7_DOC_SERVER_URL`** - URL вашего P7 Document Server (например: `http://doc-server.company.com:8080`)
- **`P7_ACCESS_TOKEN`** - токен доступа для API (если требуется аутентификация)
- **`P7_FILE_ID`** - ID файла в Document Server или имя файла (например: `Сборка Москва.xlsx`)

#### Как работает закрытие сеансов

1. **Через P7 Document Server API** (если настроен):
   - Использует WOPI REST API для получения информации о файле
   - Проверяет активные сеансы через `/api/v1/sessions`
   - Закрывает все сеансы, связанные с файлом, через DELETE запрос
   - Снимает блокировки файла через WOPI Unlock
   - Ожидает освобождения файла до 30 секунд

2. **Локальное закрытие процессов** (если API не настроен):
   - Ищет процессы P7-Офис, открывающие файл
   - Закрывает процессы через psutil
   - Ожидает освобождения файла

#### Примеры использования

**С Document Server:**
```python
# config_p7.py
P7_DOC_SERVER_URL = "http://doc-server.company.com:8080"
P7_ACCESS_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
P7_FILE_ID = "Сборка Москва.xlsx"
```

**Без Document Server (локальное закрытие):**
```python
# config_p7.py не создан или содержит значения по умолчанию
# Скрипт автоматически использует локальное закрытие процессов
```

#### Важные замечания

- Скрипт автоматически определяет, использовать ли API или локальный метод
- Если `P7_DOC_SERVER_URL` не настроен или содержит значения по умолчанию, используется локальное закрытие
- Закрытие сеансов происходит **дважды**: перед обновлением листа "остатки" и перед обновлением остатков на всех листах
- Все пользователи будут автоматически отключены от файла перед обновлением
- Файл должен быть доступен для записи после закрытия сеансов

## Использование

### Ручной запуск с почтой (основной режим):
```bash
python update_ostanki.py
```

### Тестирование с локальным файлом:
```bash
python update_ostanki.py "для бота (XLSX).xlsx"
```

### Автоматический запуск каждый день в 19:20

#### Вариант 1: Использование планировщика Python (рекомендуется)
```bash
python scheduler.py
```
Скрипт будет работать постоянно и запускать обновление каждый день в 19:20.

Для запуска в фоне можно использовать:
```bash
start /B python scheduler.py
```

Или используйте bat-файл:
```bash
start_scheduler.bat
```

#### Вариант 2: Планировщик задач Windows
Запустите `install_windows_task.bat` от имени администратора для автоматической установки задачи в планировщике Windows.

Или создайте задачу вручную:
1. Откройте "Планировщик заданий Windows"
2. Создайте новую задачу
3. Триггер: ежедневно в 19:20
4. Действие: запуск программы `python` с аргументом `scheduler.py`
5. Рабочая папка: путь к проекту

## Структура файлов

- `update_ostanki.py` - основной скрипт обновления остатков
- `scheduler.py` - планировщик для автоматического запуска
- `start_scheduler.bat` - bat-файл для запуска планировщика
- `install_windows_task.bat` - установка задачи в планировщике Windows
- `config_p7.py.example` - пример конфигурации для P7 Document Server
- `config_p7.py` - реальная конфигурация (создается вручную, не коммитится в git)
- `Сборка Москва.xlsx` - основной файл с данными
- `для бота (XLSX).xlsx` - файл с остатками (скачивается из почты или используется локально)

## Формат данных

Скрипт ищет в файле бота:
- Столбец "Номер" (числовой код каталога)
- Столбец "Номенклатура" или "Номенклатура.код"
- Столбец "Количество" (остатки)
- Столбец "Артикул" (нормализуется - убираются пробелы)

В основном файле скрипт ищет:
- Столбцы "Номер по каталогу" и "Номер по каталогу АГБ"
- Столбец "Кол-во на станок" (после него создается "Остатки на складах")

## Особенности

- **Нормализация данных**: Все номера каталога и артикулы нормализуются (убираются пробелы, приводятся к нижнему регистру)
- **Частичное совпадение**: Используется частичное совпадение при поиске (содержание строки в строке), если точного совпадения нет
- **Удаление дубликатов**: Автоматически удаляются дубликаты листа "остатки" (остатки1, остатки2 и т.д.)
- **Обработка объединенных ячеек**: Пропускаются объединенные ячейки при обновлении

## Примечания

- Скрипт суммирует остатки для одинаковых номеров каталога
- Если для номера каталога нет остатков, ставится 0
- Скрипт обновляет все листы, кроме листа "остатки"
- **Автоматическое закрытие сеансов**: Все пользователи P7-Офис автоматически отключаются от файла перед обновлением
- Если используется P7 Document Server, файл должен быть загружен в систему и доступен через API
- При работе без Document Server скрипт закрывает локальные процессы P7-Офис

## Работа с P7-Офис Document Server

### Требования

- P7-Офис Corporate Server 2024 или Document Server
- Доступ к WOPI REST API
- Файл должен быть загружен в Document Server
- Токен доступа (если требуется аутентификация)

### API Endpoints, используемые скриптом

1. **WOPI CheckFileInfo** - `GET /wopi/files/{file_id}/checkfileinfo`
   - Получение информации о файле и блокировках

2. **WOPI Unlock** - `POST /wopi/files/{file_id}/unlock`
   - Снятие блокировки файла

3. **Sessions API** - `GET /api/v1/sessions`
   - Получение списка активных сеансов

4. **Close Session** - `DELETE /api/v1/sessions/{session_id}`
   - Закрытие конкретного сеанса

### Логи работы с P7 Document Server

При работе скрипта вы увидите следующие сообщения:
- `Закрытие сеансов P7-Офис через Document Server API для файла: ...`
- `Проверка информации о файле через WOPI API...`
- `Файл найден в Document Server`
- `Найдено X активных сеансов`
- `Сеанс {session_id} закрыт`
- `Файл освобожден и готов к обновлению`

Если API не настроен:
- `P7_DOC_SERVER_URL не настроен, используем локальное закрытие процессов`
- `Локальное закрытие процессов для файла: ...`
